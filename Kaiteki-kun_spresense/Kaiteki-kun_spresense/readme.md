
# 快適くん-Spresense

## Spresenseの準備

   - 本システムを実行するにあたり、wifi機能を搭載したPCとSpresenseが必要となる。
   - Spresenseはアクセスポイントモードに対応した①のプログラムを書きこみ実行する。混雑検知システムを実行する場合はSpresenseがもう一台必要となる。こちらには②のプログラムを書きこみ、1台目を立ち上げた後に起動させる。
   
   ①`kaiteki_AP.ino`：1台目Wifiアクセスポイント対応
   
   ②`kaiteki_CL.ino`：2台目

1.開発環境
   - Spresenseの開発はArduino IDEを用いて行う。
2.WifiSSID設定
   - `AP_SSID`で任意のSSID名を設定する。
   - `PASSPHRASE`で任意のパスワードを設定する。

3.Wifiアドオンボードの設定
   - Wifi通信用にSPRESENSE Wi-Fi Add-onボード iS110Bを使用する。[公式ページ](https://idy-design.com/product/is110b.html)からAruduino IDE向けライブラリをインクルードして開発を行う。
   - iS110BがV1.0Cの場合はライブラリを対応するコードに書き換えが必要である。またメインプログラム内の関数を`Init_GS2200_SPI()`から`Init_GS2200_SPI_type(iS110B_TypeC)`に変更する必要がある。
   - 本プログラムではV1.0Cを使用する設定にしている。


4.プログラムの書き込み
   - Spresenseのメインコアに本プログラムを書き込む。メモリサイズは1152KBに変更する。
   - セットアップでエラーが起きなければ、メインボード上のLEDが順番に点灯したのち全て消灯する。
   - PC側でSpresenseのWifiアクセスポイントに接続し画像処理用のYOLOv7を実行する。
   - IPアドレスはアクセスポイントモードのSpresenseは`192.168.1.99`、その他デバイスはAPに接続した順にホスト部がインクリメントされた値となる。

## Spresenseの機能解説

1.音量測定機能
   - 快適くんの騒音防止機能で使用する。デバイス起動中にアナログマイクA端子に入力された音声波形の音量ピーク値を求めて設定したレベルを超えた場合に騒音検出のフラグを立てる（`beepstate=4`)。なおビープ音再生中はオーディオモードをマイク入力用`AS_SETRECDR_STS_INPUTDEVICE_MIC`から`AS_SETPLAYER_OUTPUTDEVICE_SPHP`に変更している。そのためマイク入力の処理を行わない。

2.ビープ音機能
   - 各種検知機能が動作してビープ音発生用フラグ(`beepstate`)が立つと、マイク入力処理を止めてビープ音をスピーカージャックより出力する。異なる周波数のビープ音を鳴らすことで検出した機能の識別ができる。

3.Wifi送受信機能
   - Wifi拡張ボード「iS110B」を用いてPCと通信を行う。Spresenseをwebサーバとして、PC側からHTTP-GETリクエストを受けるとカメラ撮影を行いJPG画像を送信する。PCからのリクエストには各検出機能の動作フラグが0と1の文字データで含まれており、この情報をもとにビープ音発生用のフラグを立てる。

4.カメラ撮影機能
   - 混雑時の偏り検知、忘れ物検知機能で使用する。PCから画像取得の要求が届くとSpresenseメインボードに繋げたカメラボードを用いて車内の画像を撮影する。撮影したデータをJPG画像にしてPCに送信する。


